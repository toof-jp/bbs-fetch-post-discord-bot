# bbs-fetch-post-discord-bot

[![CI](https://github.com/toof-jp/bbs-fetch-post-discord-bot/workflows/CI/badge.svg)](https://github.com/toof-jp/bbs-fetch-post-discord-bot/actions)

PostgreSQLに保存されているBBS（掲示板システム）の投稿データを取得し、Discord上で指定された投稿番号の内容を返信するDiscordボットです。

## 機能概要

Discord上でボットをメンションして投稿番号を指定すると、該当する投稿内容を返信します。単一の投稿、範囲指定、除外指定など、柔軟な投稿番号の指定が可能です。

## 投稿番号の指定方法

### 単一指定

特定の投稿番号を1つだけ指定する場合：

```
@bot 123
```

- 投稿番号123のみを表示します

### 範囲指定

連続する投稿番号の範囲を指定する場合：

#### 閉じた範囲指定

```
@bot 123-128
```

- 投稿番号123から128までの全ての投稿を表示します（123, 124, 125, 126, 127, 128）

#### 開いた範囲指定

```
@bot 123-
```

- 投稿番号123から最新の投稿まで全てを表示します
- データベース内の最大投稿番号まで自動的に取得されます

### 除外指定

特定の投稿番号を除外したい場合は、`^`（キャレット）を使用します：

#### 単一除外

```
@bot 123-128,^126
```

- 投稿番号123から128までを表示しますが、126は除外します
- 結果：123, 124, 125, 127, 128

#### 範囲除外

```
@bot 100-200,^150-160
```

- 投稿番号100から200までを表示しますが、150から160は除外します
- 結果：100-149, 161-200の投稿

#### 開いた範囲の除外

```
@bot 1-,^500-
```

- 投稿番号1から最新までを表示しますが、500以降は除外します
- 結果：1-499の投稿

### 相対参照指定（?プレフィックス）

`?`（クエスチョンマーク）を使用することで、現在の最大投稿番号の上位桁を基準にした相対的な番号指定ができます：

#### 単一の相対参照

```
@bot ?324
```

- 現在の最大投稿番号が123340の場合、投稿番号123324を表示します
- 最大投稿番号の下3桁を指定された番号に置き換えます

#### 相対参照の範囲指定

```
@bot ?324-326
```

- 現在の最大投稿番号が123340の場合、投稿番号123324から123326を表示します

#### 相対参照の除外

```
@bot ?320-330,?^325
```

- 現在の最大投稿番号が123340の場合、投稿番号123320から123330を表示しますが、123325は除外します

#### 相対参照の開いた範囲

```
@bot ?300-
```

- 現在の最大投稿番号が123340の場合、投稿番号123300から最新（123340）までを表示します

### 複合指定

カンマ（`,`）で区切ることで、複数の条件を組み合わせることができます：

```
@bot 10,20-25,30,^23
```

- 投稿番号10、20から25、30を表示しますが、23は除外します
- 結果：10, 20, 21, 22, 24, 25, 30

```
@bot 1-50,100-150,^25-30,^125-130
```

- 投稿番号1から50と100から150を表示しますが、25から30と125から130は除外します
- 結果：1-24, 31-50, 100-124, 131-150

```
@bot ?324,100-110,?^326-328
```

- 現在の最大投稿番号が123340の場合：
  - 投稿番号123324と100から110を表示しますが、123326から123328は除外します
  - 結果：100-110, 123324

## 技術仕様

### 処理フロー

1. **メンション検出**：ボットがメンションされたメッセージを検出
2. **パース処理**：メッセージから投稿番号の指定を解析
3. **番号計算**：
   - 含める投稿番号のセットを作成
   - 除外する投稿番号のセットを作成
   - 集合演算（差集合）により最終的な投稿番号リストを生成
4. **データベース取得**：計算された投稿番号リストに基づいてPostgreSQLから投稿データを取得
5. **返信**：取得した投稿内容をDiscordに返信

### 制限事項

- Discordの文字数制限により、1メッセージあたり1800文字を超える場合は分割して送信されます
- 指定された投稿番号が存在しない場合は、存在する投稿のみが表示されます
- 開いた範囲指定（例：`123-`）や相対参照（例：`?324`）を使用する場合、データベースへの追加クエリが発生します
- 画像付き投稿は個別のメッセージとして送信されるため、表示順序が前後する場合があります
- 相対参照は最大投稿番号の下3桁を置き換える仕組みのため、投稿番号が1000未満の場合は期待通りに動作しない可能性があります

### データベーススキーマ

投稿データは以下の構造で保存されています：

```sql
CREATE TABLE res (
    no INTEGER PRIMARY KEY,           -- 投稿番号
    name_and_trip TEXT NOT NULL,      -- 投稿者名とトリップ
    datetime TIMESTAMP NOT NULL,      -- 投稿日時
    datetime_text TEXT NOT NULL,      -- 投稿日時（テキスト形式）
    id TEXT NOT NULL,                 -- 投稿者ID
    main_text TEXT NOT NULL,          -- 投稿本文（プレーンテキスト）
    main_text_html TEXT NOT NULL,     -- 投稿本文（HTML）
    oekaki_id INTEGER                 -- お絵かきID（オプション）
);
```

### 出力フォーマット

各投稿は以下の形式で表示されます：

```
### __[投稿番号] [投稿者名] [投稿日時] ID: [投稿者ID]__
[投稿本文]
```

## 画像レス対応

投稿にお絵かきID（`oekaki_id`）が含まれている場合、該当する画像が自動的にDiscordに埋め込み（embed）として表示されます。画像URLは環境変数`IMAGE_URL_PREFIX`と`oekaki_id`を組み合わせて生成されます。

例：`IMAGE_URL_PREFIX`が`https://example.com/images/`で、`oekaki_id`が`123`の場合、画像URLは`https://example.com/images/123.png`となります。

## 環境設定

以下の環境変数を`.env`ファイルに設定する必要があります：

```env
DISCORD_TOKEN=your_discord_bot_token
DATABASE_URL=postgresql://username:password@host:port/database
IMAGE_URL_PREFIX=https://example.com/images/
```

## 依存関係

- **Serenity 0.12.4**：Discord APIとの通信
- **SQLx 0.7**：PostgreSQLデータベースとの非同期通信
- **Tokio**：非同期ランタイム
- **その他**：regex（正規表現）、chrono（日時処理）、anyhow（エラーハンドリング）など

## ビルドと実行

```bash
# 開発環境での実行
cargo run

# リリースビルド
cargo build --release

# テストの実行
cargo test

# コードフォーマット
cargo fmt

# リンターの実行
cargo clippy
```